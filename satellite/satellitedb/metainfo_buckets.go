// Copyright (C) 2019 Storj Labs, Inc.
// See LICENSE for copying information.

package satellitedb

import (
	"context"

	"github.com/skyrings/skyring-common/tools/uuid"
	"github.com/zeebo/errs"

	"storj.io/storj/pkg/storj"
	"storj.io/storj/satellite/metainfo"
	dbx "storj.io/storj/satellite/satellitedb/dbx"
)

var _ metainfo.Buckets = (*buckets)(nil)

// implementation of metainfo.Buckets interface repository using spacemonkeygo/dbx orm
type buckets struct {
	db dbx.Methods
}

func (buckets *buckets) Create(ctx context.Context, bucket *metainfo.Bucket) error {
	var attribution interface{}

	_, err := buckets.db.Create_Bucket(ctx,
		dbx.Bucket_Id(bucket.ProjectID[:]),

		dbx.Bucket_ProjectId(bucket.ProjectID[:]),
		dbx.Bucket_Name([]byte(bucket.Name)),
		dbx.Bucket_PathCipher(int(bucket.PathCipher)),

		dbx.Bucket_CreatedAt(bucket.CreatedAt.UTC()),

		dbx.Bucket_DefaultSegmentSize(int(bucket.DefaultSegmentSize)),

		dbx.Bucket_DefaultEncryptionCipherSuite(int(bucket.DefaultEncryption.CipherSuite)),
		dbx.Bucket_DefaultEncryptionBlockSize(int(bucket.DefaultEncryption.BlockSize)),

		dbx.Bucket_DefaultRedundancyAlgorithm(int(bucket.DefaultRedundancy.Algorithm)),
		dbx.Bucket_DefaultRedundancyShareSize(int(bucket.DefaultRedundancy.ShareSize)),
		dbx.Bucket_DefaultRedundancyRequiredShares(int(bucket.DefaultRedundancy.RequiredShares)),
		dbx.Bucket_DefaultRedundancyRepairShares(int(bucket.DefaultRedundancy.RepairShares)),
		dbx.Bucket_DefaultRedundancyOptimalShares(int(bucket.DefaultRedundancy.OptimalShares)),
		dbx.Bucket_DefaultRedundancyTotalShares(int(bucket.DefaultRedundancy.TotalShares)),

		dbx.Bucket_Create_Fields{
			// AttributionID uuid.UUID, optional
		},
	)

	return err
}

func (buckets *buckets) Get(ctx context.Context, projectID uuid.UUID, name string) (*metainfo.Bucket, error) {

}

func (buckets *buckets) Delete(ctx context.Context, projectID uuid.UUID, name string) error {

}

func (buckets *buckets) List(ctx context.Context, projectID uuid.UUID, opts storj.BucketListOptions) (storj.BucketList, error) {

}

// bucketFromDBX is used for creating Project entity from autogenerated dbx.Project struct
func bucketFromDBX(bucket *dbx.Bucket) (*metainfo.Bucket, error) {
	if bucket == nil {
		return nil, errs.New("bucket parameter is nil")
	}

	id, err := bytesToUUID(bucket.Id)
	if err != nil {
		return nil, err
	}

	projectID, err := bytesToUUID(bucket.ProjectId)
	if err != nil {
		return nil, err
	}

	var attributionID uuid.UUID
	if bucket.AttributionId == nil {
		parsedID, err := bytesToUUID(bucket.AttributionId)
		if err != nil {
			return nil, err
		}
		attributionID = parsedID
	}

	return &metainfo.Bucket{
		ID: id,

		ProjectID:  projectID,
		Name:       string(bucket.Name),
		PathCipher: storj.Cipher(bucket.PathCipher),

		AttributionID: attributionID,
		CreatedAt:     bucket.CreatedAt,

		DefaultSegmentSize: int64(bucket.DefaultSegmentSize),
		DefaultEncryption: storj.EncryptionParameters{
			CipherSuite: storj.CipherSuite(bucket.DefaultEncryptionCipherSuite),
			BlockSize:   int32(bucket.DefaultEncryptionBlockSize),
		},
		DefaultRedundancy: storj.RedundancyScheme{
			Algorithm:      storj.RedundancyAlgorithm(bucket.DefaultRedundancyAlgorithm),
			ShareSize:      int32(bucket.DefaultRedundancyShareSize),
			RequiredShares: int16(bucket.DefaultRedundancyRequiredShares),
			RepairShares:   int16(bucket.DefaultRedundancyRepairShares),
			OptimalShares:  int16(bucket.DefaultRedundancyOptimalShares),
			TotalShares:    int16(bucket.DefaultRedundancyTotalShares),
		},
	}, nil
}
